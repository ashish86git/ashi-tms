{% extends "layout.html" %}

{% block title %}Create Indent{% endblock %}

{% block content %}
<div class="container-fluid">

  {# ───────────────────────── Flash Messages / Success Modal ───────────────────── #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      {% if category == 'success' %}
        <button type="button" class="d-none" id="flashModalBtn" data-bs-toggle="modal" data-bs-target="#flashModal"></button>
        <div class="modal fade" id="flashModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle-fill me-1"></i> Success</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">{{ message }}</div>
            </div>
          </div>
        </div>
        <script>
          document.addEventListener('DOMContentLoaded',()=>{document.getElementById('flashModalBtn').click();});
        </script>
      {% else %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endif %}
    {% endfor %}
  {% endwith %}

  {# ───────────────────────── Uploaded Indent Table ──────────────────────────────── #}
  {% if indent_data %}
  <div class="card shadow mb-4 border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-table me-2"></i> All Submitted Indents</h5>
      <a href="{{ url_for('export_indents') }}" class="btn btn-light btn-sm">
        <i class="bi bi-file-earmark-arrow-down me-1"></i> Export to CSV
      </a>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            {% for key in indent_data[0].keys() %}
              <th>{{ key.replace('_',' ').title() }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in indent_data %}
          <tr>
            {% for value in row.values() %}
              <td>{{ value }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {# ───────────────────────── Upload Excel/CSV Card ──────────────────────────────── #}
  <div class="card shadow mb-4 border-0">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-upload me-2"></i> Upload Indent Excel/CSV</h5>
    </div>
    <div class="card-body">
      <form method="post" action="{{ url_for('upload_indent') }}" enctype="multipart/form-data">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-semibold"><i class="bi bi-file-earmark-spreadsheet me-1"></i> File</label>
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required class="form-control shadow-sm" />
          </div>
          <div class="col-md-6">
            <button type="submit" class="btn btn-info px-4">
              <i class="bi bi-upload me-1"></i> Upload
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# ───────────────────────── Master Model Shortcut ────────────────────── #}
  <div class="mb-4 text-end">
    <a href="{{ url_for('master_model') }}" class="btn btn-dark">
      <i class="bi bi-box-seam me-1"></i> Master Model
    </a>
  </div>

  {# ───────────────────────── Create New Indent ──────────────────────────── #}
  <div class="card shadow border-0">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i> Create New Indent</h5>
    </div>
    <div class="card-body">
      <form method="post" class="row g-4">

        {# ── Indent General Info ── #}
        <div class="col-md-3">
          <label class="form-label">Indent Date</label>
          <input type="date" name="indent_date" class="form-control shadow-sm" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Indent #</label>
          <input type="text" name="indent" class="form-control shadow-sm" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Allocation Date</label>
          <input type="date" name="allocation_date" class="form-control shadow-sm" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Pickup Location</label>
          <input type="text" name="pickup_location" value="Sonipat" required class="form-control shadow-sm" />
        </div>

        {# ───────────── Customer Sections ───────────── #}
        <div class="col-12 mt-3">
          <label class="form-label fw-semibold">Customer Details</label>
          <div id="customerSectionContainer">

            <!-- Customer Block -->
            <div class="customer-block border rounded p-3 mb-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-primary fw-semibold mb-0">Customer #1</h6>
                <button type="button" class="btn btn-outline-danger btn-sm removeCustomer d-none">
                  <i class="bi bi-trash"></i> Remove
                </button>
              </div>

              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Customer Name</label>
                  <input type="text" name="customers[0][name]" class="form-control shadow-sm" required />
                </div>

                <div class="col-md-3">
                  <label class="form-label">Range</label>
                  <select name="customers[0][range]" class="form-select shadow-sm" required>
                    <option value="">-- Select Range --</option>
                    <option value="0-100">0-100</option>
                    <option value="101-250">101-250</option>
                    <option value="251-400">251-400</option>
                    <option value="custom">Customize</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Drop Location</label>
                  <input type="text" name="customers[0][drop_location]" class="form-control shadow-sm" required />
                </div>

                <div class="col-md-3">
                  <label class="form-label">LR No.</label>
                  <input type="text" name="customers[0][lr_no]" class="form-control shadow-sm" />
                </div>

                <div class="col-md-3">
                  <label class="form-label">Material</label>
                  <input type="text" name="customers[0][material]" class="form-control shadow-sm" />
                </div>

                <div class="col-md-3">
                  <label class="form-label">Load per Bucket (Kg)</label>
                  <input type="number" name="customers[0][load_per_bucket]" class="form-control shadow-sm loadPerBucketInput" />
                </div>

                <div class="col-md-3">
                  <label class="form-label">No. Buckets</label>
                  <input type="number" name="customers[0][no_of_buckets]" class="form-control shadow-sm noOfBucketsInput" />
                </div>

                <div class="col-md-3">
                  <label class="form-label">Total Load (Kg)</label>
                  <input type="number" name="customers[0][total_load]" class="form-control shadow-sm totalLoadInput" readonly />
                </div>
              </div>
            </div>
          </div>

          <!-- Add Another Customer -->
          <div class="text-end">
            <button type="button" class="btn btn-outline-primary mt-2" id="addCustomerBtn">
              <i class="bi bi-plus-circle"></i> Add Another Customer
            </button>
          </div>
        </div>

        {# ───────────── Vehicle & Other Info ───────────── #}
        <div class="col-md-3">
          <label class="form-label">Vehicle Number</label>
          <select name="vehicle_number" required class="form-select shadow-sm">
            <option value="">-- Select Vehicle --</option>
            {% for v in fleet_data %}
              <option value="{{ v }}">{{ v }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Vehicle Model</label>
          <input type="text" name="vehicle_model" class="form-control shadow-sm" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Vehicle Based</label>
          <input type="text" name="vehicle_based" class="form-control shadow-sm" />
        </div>

        <div class="col-md-3">
          <label class="form-label">POD Received</label>
          <select name="pod_received" class="form-select shadow-sm">
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Freight Tiger No.</label>
          <input type="text" name="freight_tiger_number" class="form-control shadow-sm" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Freight Tiger Month</label>
          <input type="month" name="freight_tiger_month" class="form-control shadow-sm" />
        </div>

        {# ── Submit Button ── #}
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success px-5 mt-3">
            <i class="bi bi-plus-circle me-1"></i> Create Indent
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ───────────── JavaScript Section ───────────── #}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const container = document.getElementById("customerSectionContainer");
  const addBtn = document.getElementById("addCustomerBtn");

  // Add new customer block
  addBtn.addEventListener("click", () => {
    const count = container.querySelectorAll(".customer-block").length;
    const newBlock = container.firstElementChild.cloneNode(true);

    newBlock.querySelector("h6").textContent = `Customer #${count + 1}`;
    newBlock.querySelectorAll("input, select").forEach(input => {
      input.value = "";
      const name = input.getAttribute("name");
      input.setAttribute("name", name.replace(/\[\d+\]/, `[${count}]`));
    });

    newBlock.querySelector(".removeCustomer").classList.remove("d-none");
    container.appendChild(newBlock);
  });

  // Remove customer block
  container.addEventListener("click", e => {
    if (e.target.closest(".removeCustomer")) {
      e.target.closest(".customer-block").remove();
      updateLabels();
    }
  });

  function updateLabels() {
    const blocks = container.querySelectorAll(".customer-block");
    blocks.forEach((block, i) => {
      block.querySelector("h6").textContent = `Customer #${i + 1}`;
      block.querySelectorAll("input, select").forEach(input => {
        const name = input.getAttribute("name");
        input.setAttribute("name", name.replace(/\[\d+\]/, `[${i}]`));
      });
    });
  }

  // Auto-calculate total load for each customer
  container.addEventListener("input", e => {
    if (e.target.classList.contains("loadPerBucketInput") || e.target.classList.contains("noOfBucketsInput")) {
      const block = e.target.closest(".customer-block");
      const load = parseFloat(block.querySelector(".loadPerBucketInput").value) || 0;
      const buckets = parseFloat(block.querySelector(".noOfBucketsInput").value) || 0;
      block.querySelector(".totalLoadInput").value = load * buckets;
    }
  });
});
</script>
{% endblock %}
