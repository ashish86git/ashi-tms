{% extends "layout.html" %}

{% block title %}Create Indent{% endblock %}

{% block content %}
<style>
    /* ---------------------------------------------------- */
    /* --- Base Styling for Theme Consistency --- */
    /* ---------------------------------------------------- */
    .card {
        border-radius: 8px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15) !important;
    }

    /* Primary Header (Maroon) */
    .card-header.bg-primary {
        background-color: var(--primary-maroon) !important;
        border-bottom: 2px solid var(--accent-gold);
        color: var(--text-light) !important;
        font-weight: 600;
        border-radius: 8px 8px 0 0 !important;
    }

    /* Info Header (Red) */
    .card-header.bg-info {
        background-color: var(--secondary-red) !important;
        color: var(--text-light) !important;
        font-weight: 600;
        border-radius: 8px 8px 0 0 !important;
    }

    /* Success Header (Green) */
    .card-header.bg-success {
        background-color: #28a745 !important;
        color: var(--text-light) !important;
        font-weight: 600;
        border-radius: 8px 8px 0 0 !important;
    }

    /* Table Styling */
    #indentTable thead.table-dark {
        background-color: var(--primary-maroon);
        color: var(--text-light);
        border: none;
    }
    #indentTable tbody tr:hover {
        background-color: #fce4e4;
    }

    /* Standard Button Consistency */
    .btn-light {
        color: var(--primary-maroon) !important;
        border: 1px solid var(--primary-maroon);
    }
    .btn-light:hover {
        background-color: var(--primary-maroon) !important;
        color: var(--text-light) !important;
    }
    .btn-info {
        background-color: var(--secondary-red) !important;
        border-color: var(--secondary-red) !important;
    }
    .btn-dark {
        background-color: var(--primary-maroon) !important;
        border-color: var(--primary-maroon) !important;
    }

    /* Smooth scroll for Create Indent button */
    .scroll-to-create {
        cursor: pointer;
    }

    /* Form Focus */
    .form-control:focus, .form-select:focus {
        border-color: var(--accent-gold);
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
    }

    /* ---------------------------------------------------- */
    /* --- Filter Button Group Customization --- */
    /* ---------------------------------------------------- */
    #status-filter-group .btn {
        font-weight: 500;
        transition: all 0.3s;
    }

    /* Primary (All Indents) */
    #status-filter-group .btn-primary {
        background-color: var(--primary-maroon);
        border-color: var(--primary-maroon);
    }

    /* Vehicle Received Filter (Secondary/Gray) */
    #status-filter-group button[data-filter="received"] {
        background-color: #6c757d;
        border-color: #6c757d;
        color: var(--text-light);
    }

    /* Loading Filter (Warning/Gold) */
    #status-filter-group button[data-filter="loading"] {
        background-color: var(--accent-gold);
        border-color: var(--accent-gold);
        color: var(--text-dark);
    }

    /* Ensuring Active State is Highlighting */
    #status-filter-group .btn.active {
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.5);
        opacity: 0.9;
        font-weight: 600;
    }

    /* Adjusting active color for the 'received' button */
    #status-filter-group button[data-filter="received"].active {
        box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.5);
    }

    /* ---------------------------------------------------- */
    /* --- Status Tracker Modal Customization --- */
    /* ---------------------------------------------------- */

    /* Modal Header */
    #statusModal .modal-header.bg-secondary {
        background-color: var(--primary-maroon) !important;
    }

    /* Vehicle Received Button (Outline Secondary/Gray) */
    #btnReceived { border-color: #6c757d !important; color: #6c757d !important; }
    #btnReceived:hover { background-color: #6c757d !important; color: var(--text-light) !important; }

    /* Loading Button (Outline Warning/Gold) */
    #btnLoading { border-color: var(--accent-gold) !important; color: var(--text-dark) !important; }
    #btnLoading:hover { background-color: var(--accent-gold) !important; color: var(--text-dark) !important; }

    /* Parking Button (Outline Primary/Info/Blue) */
    #btnParking { border-color: #17a2b8 !important; color: #17a2b8 !important; }
    #btnParking:hover { background-color: #17a2b8 !important; color: var(--text-light) !important; }

    /* Exit Button (Outline Success/Green) */
    #btnExit { border-color: #28a745 !important; color: #28a745 !important; }
    #btnExit:hover { background-color: #28a745 !important; color: var(--text-light) !important; }

    /* Progress Bar Themeing */
    #statusProgress {
        font-weight: 600;
        height: 32px !important;
        font-size: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
</style>

<div class="container-fluid">

  {# ───────────────────────── Flash Messages / Success Modal ───────────────────── #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      {% if category == 'success' %}
        {# Success Modal remains for visual impact #}
        <button type="button" class="d-none" id="flashModalBtn" data-bs-toggle="modal" data-bs-target="#flashModal"></button>
        <div class="modal fade" id="flashModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle-fill me-1"></i> Success</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body fw-semibold">{{ message }}</div>
            </div>
          </div>
        </div>
        <script>
          // Ensure modal shows on page load if success flash message is present
          document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('flashModalBtn').click();
          });
        </script>
      {% else %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endif %}
    {% endfor %}
  {% endwith %}

  {# ───────────────────────── Combined Filter Section ────────────────────────────── #}
  {% if indent_data %}
  <div class="card shadow mb-4 border-0">
    <div class="card-body py-4">
      <div class="row align-items-center">

        {# Status Filters #}
        <div class="col-md-7 mb-3 mb-md-0">
          <h6 class="mb-2 fw-bold"><i class="bi bi-funnel me-1 text-primary"></i> Filter by Status:</h6>
          <div class="btn-group shadow-sm" role="group" id="status-filter-group">
            <button type="button" class="btn btn-primary active" data-filter="all">All Indents</button>

            <button type="button" class="btn btn-secondary" data-filter="received">Vehicle Received</button>
            <button type="button" class="btn btn-warning" data-filter="loading">Loading</button>

            <button type="button" class="btn btn-info" data-filter="parking">Parking</button>
            <button type="button" class="btn btn-success" data-filter="exit">Ready to Exit</button>
          </div>
        </div>

        {# Date Filters and Create Button #}
        <div class="col-md-5 text-md-end">
            <div class="d-flex justify-content-end align-items-center flex-wrap">

                {# Create New Indent Button (Smart Button) #}
                <button type="button" class="btn btn-success me-3 shadow-sm scroll-to-create" title="Create New Indent">
                    <i class="bi bi-plus-circle me-1"></i> Create New
                </button>

                {# Date Filter Dropdown #}
                <div>
                    <h6 class="mb-2 fw-bold"><i class="bi bi-calendar-check me-1 text-primary"></i> Filter by Date:</h6>
                    <div class="dropdown d-inline-block">
                      <button class="btn btn-secondary dropdown-toggle shadow-sm" type="button" id="dateFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-current-date-filter="all">
                        All Dates
                      </button>
                      <ul class="dropdown-menu shadow-lg" aria-labelledby="dateFilterDropdown" id="date-filter-menu">
                        <li><a class="dropdown-item active" href="#" data-date-filter="all">All Dates</a></li>
                        <li><a class="dropdown-item" href="#" data-date-filter="today">Today</a></li>
                        <li><a class="dropdown-item" href="#" data-date-filter="week">This Week</a></li>
                      </ul>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {# ───────────────────────── Uploaded Indent Table ──────────────────────────────── #}
  {% if indent_data %}
  <div class="card shadow-lg mb-4 border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-table me-2"></i> All Submitted Indents</h5>
      <a href="{{ url_for('export_indents') }}" class="btn btn-light btn-sm shadow-sm">
        <i class="bi bi-file-earmark-arrow-down me-1"></i> Export to CSV
      </a>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-hover align-middle" id="indentTable">
        <thead class="table-dark">
          <tr>
            {# हेडर रेंडरिंग #}
            {% for key in indent_data[0].keys() %}
              {% if key == 'received_time' %}
                <th>Vehicle Received</th>
              {% elif key == 'loading_time' %}
                <th>Loading Time</th>
              {% elif key == 'parking_time' %}
                <th>Parking Time</th>
              {% elif key == 'exit_time' %}
                <th>Exit Time</th>
              {% elif key == 'status' %}
                <th>Status</th>
              {% elif key == 'vehicle_number' %}
                <th>Vehicle Number</th>
              {% else %}
                <th>{{ key.replace('_',' ').title() }}</th>
              {% endif %}
            {% endfor %}
            <th>Status Tracker</th>
          </tr>
        </thead>
        <tbody id="indentTableBody">
          {# Assuming 'row.status' and 'row.indent_date' are available in your Jinja context #}
          {% for row in indent_data %}

          <tr data-status="{{ row.status | default('unknown') }}" data-date="{{ row.indent_date }}">
            {% for key, value in row.items() %}
                {# value को सीधे प्रिंट करें, क्योंकि स्टेटस और टाइमस्टैम्प अब डेटा का हिस्सा हैं #}
              <td>{{ value }}</td>
            {% endfor %}
            <td>
              <button class="btn btn-outline-primary btn-sm track-status-btn"
                      data-indent="{{ row['indent'] }}"
                      data-vehicle="{{ row['vehicle_number'] }}">
                <i class="bi bi-truck"></i> Track
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {# ───────────────────────── Upload Excel/CSV Card ──────────────────────────────── #}
  <div class="card shadow mb-4 border-0">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-upload me-2"></i> Upload Indent Excel/CSV</h5>
    </div>
    <div class="card-body">
      <form method="post" action="{{ url_for('upload_indent') }}" enctype="multipart/form-data">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-semibold"><i class="bi bi-file-earmark-spreadsheet me-1"></i> File</label>
            <input type="file" name="file" accept=".xlsx,.xls,.csv" required class="form-control shadow-sm" />
          </div>
          <div class="col-md-6">
            <button type="submit" class="btn btn-info px-4 shadow-sm">
              <i class="bi bi-upload me-1"></i> Upload Indent
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# ───────────────────────── Master Model Shortcut ────────────────────── #}
  <div class="mb-4 text-end">
    <a href="{{ url_for('master_model') }}" class="btn btn-dark shadow-sm">
      <i class="bi bi-box-seam me-1"></i> Master Model Settings
    </a>
  </div>

  {# ───────────────────────── Create New Indent Form Target ──────────────────────────── #}
  <div class="card shadow-lg border-0" id="create-indent-form-target">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i> Create New Indent</h5>
    </div>
    <div class="card-body">
      <form method="post" class="row g-4">

        {# ── Indent General Info ── #}
        <div class="col-md-3">
          <label class="form-label fw-semibold">Indent Date</label>
          <input type="date" name="indent_date" class="form-control shadow-sm" required />
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Indent #</label>
          <input type="text" name="indent" class="form-control shadow-sm" required />
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Allocation Date</label>
          <input type="date" name="allocation_date" class="form-control shadow-sm" />
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Pickup Location</label>
          <input type="text" name="pickup_location" value="Sonipat" required class="form-control shadow-sm" />
        </div>

        {# ───────────── Customer Sections ───────────── #}
        <div class="col-12 mt-3">
          <label class="form-label fs-5 fw-bold text-secondary">Customer Details</label>
          <div id="customerSectionContainer">
            <div class="customer-block border rounded p-4 mb-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <h6 class="text-primary fw-bold mb-0">Customer #1</h6>
                <button type="button" class="btn btn-danger btn-sm removeCustomer d-none">
                  <i class="bi bi-trash"></i> Remove Customer
                </button>
              </div>
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Customer Name</label>
                  <input type="text" name="customers[0][name]" class="form-control shadow-sm" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Range</label>
                  <select name="customers[0][range]" class="form-select shadow-sm" required>
                    <option value="">-- Select Range --</option>
                    <option value="0-100">0-100</option>
                    <option value="101-250">101-250</option>
                    <option value="251-400">251-400</option>
                    <option value="custom">Customize</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Drop Location</label>
                  <input type="text" name="customers[0][drop_location]" class="form-control shadow-sm" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">LR No.</label>
                  <input type="text" name="customers[0][lr_no]" class="form-control shadow-sm" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Material</label>
                  <input type="text" name="customers[0][material]" class="form-control shadow-sm" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Load per Bucket (Kg)</label>
                  <input type="number" name="customers[0][load_per_bucket]" class="form-control shadow-sm loadPerBucketInput" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">No. Buckets</label>
                  <input type="number" name="customers[0][no_of_buckets]" class="form-control shadow-sm noOfBucketsInput" />
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold text-success">Total Load (Kg)</label>
                  <input type="number" name="customers[0][total_load]" class="form-control shadow-sm totalLoadInput bg-light" readonly />
                </div>
              </div>
            </div>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-outline-primary mt-2 shadow-sm" id="addCustomerBtn">
              <i class="bi bi-plus-circle"></i> Add Another Customer
            </button>
          </div>
        </div>

        {# ───────────── Vehicle & Other Info ───────────── #}
        <div class="col-12"><h5 class="fw-bold text-secondary border-bottom pb-2">Vehicle Assignment & POD</h5></div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Vehicle Number</label>
          <select name="vehicle_number" required class="form-select shadow-sm">
            <option value="">-- Select Vehicle --</option>
            {% for v in fleet_data %}
              <option value="{{ v }}">{{ v }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Vehicle Model</label>
          <input type="text" name="vehicle_model" class="form-control shadow-sm" />
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Vehicle Based</label>
          <input type="text" name="vehicle_based" class="form-control shadow-sm" />
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Driver Name</label>
          <input type="text" name="driver_name" placeholder="Driver Name" class="form-control shadow-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Driver Contact Number</label>
          <input type="text" name="driver_contact" placeholder="Driver Contact Number" class="form-control shadow-sm">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">POD Received</label>
          <select name="pod_received" class="form-select shadow-sm">
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Freight Tiger No.</label>
          <input type="text" name="freight_tiger_number" class="form-control shadow-sm" />
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Freight Tiger Month</label>
          <input type="month" name="freight_tiger_month" class="form-control shadow-sm" />
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success px-5 py-2 mt-3 shadow-lg">
            <i class="bi bi-plus-circle me-1"></i> Create Indent
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ───────────────────── Vehicle Status Tracker Modal ───────────────────── #}
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title"><i class="bi bi-truck me-2"></i> Vehicle Status Tracker: <span id="modalVehicleID" class="fw-bold text-warning"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 class="mb-3">Indent: <span id="modalIndentID" class="text-primary fw-bold"></span></h6>
        <div class="progress my-4" style="height: 32px;">
          <div id="statusProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%;">
            Waiting to Start...
          </div>
        </div>
        <div class="row text-center mt-5">
          <div class="col">
            {# Icon: text-secondary #}
            <i class="bi bi-box2-fill fs-3 text-secondary"></i>
            <p class="fw-semibold mb-0">Vehicle Received</p>
            <small id="vehicle_received" class="text-muted">–</small>
          </div>
          <div class="col">
            <i class="bi bi-box2-fill fs-3 text-warning"></i>
            <p class="fw-semibold mb-0">Loading</p>
            <small id="loadTime" class="text-muted">–</small>
          </div>
          <div class="col">
            <i class="bi bi-p-square-fill fs-3 text-primary"></i>
            <p class="fw-semibold mb-0">Parking</p>
            <small id="parkTime" class="text-muted">–</small>
          </div>
          <div class="col">
            <i class="bi bi-door-open-fill fs-3 text-success"></i>
            <p class="fw-semibold mb-0">Ready to Exit</p>
            <small id="exitTime" class="text-muted">–</small>
          </div>
        </div>
        <div class="text-center mt-5 pt-3 border-top">
          {# Vehicle Received Button: btn-outline-secondary (Gray) #}
          <button class="btn btn-outline-secondary me-2 fw-semibold" id="btnReceived" data-status="received"><i class="bi bi-box2"></i> Vehicle Received</button>

          {# Loading Button: btn-outline-warning (Gold) #}
          <button class="btn btn-outline-warning me-2 fw-semibold" id="btnLoading" data-status="loading"><i class="bi bi-box2"></i> Start Loading</button>

          <button class="btn btn-outline-primary me-2 fw-semibold" id="btnParking" data-status="parking" disabled><i class="bi bi-p-square"></i> Move to Parking</button>
          <button class="btn btn-outline-success fw-semibold" id="btnExit" data-status="exit" disabled><i class="bi bi-door-open"></i> Ready to Exit</button>
        </div>
      </div>
    </div>
  </div>
</div>

{# ───────────────────────────── JavaScript Section (LOGIC UNCHANGED) ───────────────────────────── #}
<script>
document.addEventListener("DOMContentLoaded", function () {

  // --- 1. DOM Element Caching ---
  const statusModal = new bootstrap.Modal(document.getElementById("statusModal"));
  const progressBar = document.getElementById("statusProgress");
  const modalVehicleID = document.getElementById("modalVehicleID");
  const modalIndentID = document.getElementById("modalIndentID");

  const vehicleReceivedTime = document.getElementById("vehicle_received");
  const loadTime = document.getElementById("loadTime");
  const parkTime = document.getElementById("parkTime");
  const exitTime = document.getElementById("exitTime");

  const btnReceived = document.getElementById("btnReceived");
  const btnLoading = document.getElementById("btnLoading");
  const btnParking = document.getElementById("btnParking");
  const btnExit = document.getElementById("btnExit");

  const trackBtns = document.querySelectorAll(".track-status-btn");

  const filterGroupStatus = document.getElementById('status-filter-group');
  const filterGroupDate = document.getElementById('date-filter-menu');
  const dateFilterDropdownBtn = document.getElementById('dateFilterDropdown');
  const tableRows = document.querySelectorAll('#indentTableBody tr');

  // New element for smooth scrolling
  const scrollToCreateBtn = document.querySelector('.scroll-to-create');
  const createFormTarget = document.getElementById('create-indent-form-target');

  // ------------------- Scroll to Create Form -------------------
  if (scrollToCreateBtn && createFormTarget) {
      scrollToCreateBtn.addEventListener('click', () => {
          createFormTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
  }


  // ------------------- Convert UTC → IST (LOGIC UNCHANGED - TIMEZONE FIXED) -------------------
  function convertToIST(utcTimestamp) {
      if (!utcTimestamp) return null;
      try {
          const date = new Date(utcTimestamp);
          // Fixed to en-IN and Asia/Kolkata for consistent IST display
          return date.toLocaleTimeString("en-IN", {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: true,
              timeZone: "Asia/Kolkata",
          });
      } catch (e) {
          console.error("Error converting time:", e);
          return utcTimestamp;
      }
  }


  // ------------------- UPDATE UI (LOGIC UNCHANGED) -------------------
  function updateModalUI(status, recT, loadT, parkT, exitT) {

    let width = "0%";
    let barText = "Waiting for Vehicle Arrival...";
    let barClass = "bg-secondary";

    let receivedDisabled = false;
    let loadingDisabled = true;
    let parkingDisabled = true;
    let exitDisabled = true;

    if (status === "received") {
      width = "25%";
      barText = "Vehicle Received";
      barClass = "bg-info";
      receivedDisabled = true;
      loadingDisabled = false;

    } else if (status === "loading") {
      width = "50%";
      barText = "Loading...";
      barClass = "bg-warning";
      receivedDisabled = true;
      loadingDisabled = true;
      parkingDisabled = false;

    } else if (status === "parking") {
      width = "75%";
      barText = "Vehicle Parked";
      barClass = "bg-primary";
      receivedDisabled = true;
      loadingDisabled = true;
      parkingDisabled = true;
      exitDisabled = false;

    } else if (status === "exit") {
      width = "100%";
      barText = "Exit Completed";
      barClass = "bg-success";
      receivedDisabled = true;
      loadingDisabled = true;
      parkingDisabled = true;
      exitDisabled = true;
    }

    // update timestamps
    vehicleReceivedTime.textContent = recT || "–";
    loadTime.textContent = loadT || "–";
    parkTime.textContent = parkT || "–";
    exitTime.textContent = exitT || "–";

    progressBar.style.width = width;
    progressBar.className = `progress-bar progress-bar-striped progress-bar-animated ${barClass}`;
    progressBar.textContent = barText;

    btnReceived.disabled = receivedDisabled;
    btnLoading.disabled = loadingDisabled;
    btnParking.disabled = parkingDisabled;
    btnExit.disabled = exitDisabled;
  }


  // ------------------- API: FETCH STATUS (LOGIC UNCHANGED) -------------------
  async function fetchStatus(indent, vehicle) {
    try {
        const res = await fetch(`/get_status?indent=${indent}&vehicle=${vehicle}`);
        if (!res.ok) throw new Error('Network response was not ok');
        return await res.json();
    } catch (error) {
        console.error("Error fetching status:", error);
        return { status: null, received_time: null, loading_time: null, parking_time: null, exit_time: null };
    }
  }

  // ------------------- API: UPDATE STATUS (LOGIC UNCHANGED) -------------------
  async function updateStatus(status) {
    const indent = modalIndentID.textContent;
    const vehicle = modalVehicleID.textContent;

    try {
        const res = await fetch("/update_status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ indent, vehicle, status }),
        });
        if (!res.ok) throw new Error('Network response was not ok');
        return res.json();
    } catch (error) {
        console.error("Error updating status:", error);
        return { status: null, timestamp: null };
    }
  }


  // ------------------- Open Modal + Load Status (LOGIC UNCHANGED) -------------------
  trackBtns.forEach(btn => {
    btn.addEventListener("click", async () => {

      const indent = btn.dataset.indent;
      const vehicle = btn.dataset.vehicle;

      modalIndentID.textContent = indent;
      modalVehicleID.textContent = vehicle;

      updateModalUI(null, null, null, null, null);

      const data = await fetchStatus(indent, vehicle);

      const recIST = convertToIST(data.received_time);
      const loadIST = convertToIST(data.loading_time);
      const parkIST = convertToIST(data.parking_time);
      const exitIST = convertToIST(data.exit_time);

      updateModalUI(data.status, recIST, loadIST, parkIST, exitIST);

      statusModal.show();
    });
  });


  // ------------------- BUTTON EVENTS (LOGIC UNCHANGED) -------------------

  btnReceived.addEventListener("click", async () => {
    const data = await updateStatus("received");
    const ist = convertToIST(data.timestamp);
    updateModalUI("received", ist, null, null, null);
  });

  btnLoading.addEventListener("click", async () => {
    const data = await updateStatus("loading");
    const ist = convertToIST(data.timestamp);
    updateModalUI("loading", vehicleReceivedTime.textContent, ist, null, null);
  });

  btnParking.addEventListener("click", async () => {
    const data = await updateStatus("parking");
    const ist = convertToIST(data.timestamp);
    updateModalUI("parking", vehicleReceivedTime.textContent,
                  loadTime.textContent, ist, null);
  });

  btnExit.addEventListener("click", async () => {
    const data = await updateStatus("exit");
    const ist = convertToIST(data.timestamp);
    updateModalUI("exit", vehicleReceivedTime.textContent,
                  loadTime.textContent, parkTime.textContent, ist);
  });




  /* ---------------------------------------------------
        CUSTOMER INPUT LOGIC (UNCHANGED)
  --------------------------------------------------- */

  const container = document.getElementById("customerSectionContainer");
  const addBtn = document.getElementById("addCustomerBtn");

  function updateLabels() {
    const blocks = container.querySelectorAll(".customer-block");
    blocks.forEach((block, i) => {
      block.querySelector("h6").textContent = `Customer #${i + 1}`;
      block.querySelectorAll("input, select").forEach(input => {
        input.name = input.name.replace(/\[\d+\]/, `[${i}]`);
      });
      if (i > 0) block.querySelector(".removeCustomer").classList.remove("d-none");
      else block.querySelector(".removeCustomer").classList.add("d-none");
    });
  }

  updateLabels();

  addBtn.addEventListener("click", () => {
    const newBlock = container.firstElementChild.cloneNode(true);
    newBlock.querySelectorAll("input, select").forEach(inp => inp.value = "");
    container.appendChild(newBlock);
    updateLabels();
  });

  container.addEventListener("click", e => {
    if (e.target.closest(".removeCustomer")) {
      e.target.closest(".customer-block").remove();
      updateLabels();
    }
  });

  container.addEventListener("input", e => {
    if (e.target.classList.contains("loadPerBucketInput") ||
        e.target.classList.contains("noOfBucketsInput")) {

      const block = e.target.closest(".customer-block");
      const loadInput = block.querySelector(".loadPerBucketInput");
      const bucketsInput = block.querySelector(".noOfBucketsInput");
      const totalLoadInput = block.querySelector(".totalLoadInput");

      const load = parseFloat(loadInput.value) || 0;
      const buckets = parseFloat(bucketsInput.value) || 0;

      totalLoadInput.value = (load * buckets).toFixed(2);
    }
  });


  /* ---------------------------------------------------
        TABLE FILTER LOGIC (UNCHANGED)
  --------------------------------------------------- */
  // Adjusted to use Asia/Kolkata for filter comparison
  const formatDate = d => {
      return new Intl.DateTimeFormat('en-CA', {
          timeZone: 'Asia/Kolkata',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
      }).format(d);
  };

  const getStartOfWeek = d => {
    const temp = new Date(d.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
    temp.setDate(temp.getDate() - temp.getDay());
    return formatDate(temp);
  };

  function applyFilters() {
    const sFilter = filterGroupStatus.querySelector(".active").dataset.filter;
    const dFilter = dateFilterDropdownBtn.dataset.currentDateFilter;
    const today = formatDate(new Date());
    const weekStart = getStartOfWeek(new Date());

    tableRows.forEach(row => {
      const rStatus = row.dataset.status;
      const rDate = row.dataset.date;

      const statusOK = sFilter === "all" || rStatus === sFilter;
      let dateOK = false;

      if (dFilter === "all") {
          dateOK = true;
      } else if (dFilter === "today") {
          dateOK = (rDate === today);
      } else if (dFilter === "week") {
          dateOK = (rDate >= weekStart);
      }

      row.style.display = (statusOK && dateOK) ? "" : "none";
    });
  }

  filterGroupStatus.addEventListener("click", e => {
    const btn = e.target.closest("button");
    if (!btn) return;
    filterGroupStatus.querySelectorAll("button").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");
    applyFilters();
  });

  filterGroupDate.addEventListener("click", e => {
    const item = e.target.closest("a");
    if (!item) return;

    filterGroupDate.querySelectorAll(".dropdown-item").forEach(x => x.classList.remove("active"));
    item.classList.add("active");

    dateFilterDropdownBtn.textContent = item.textContent;
    dateFilterDropdownBtn.dataset.currentDateFilter = item.dataset.dateFilter;

    applyFilters();
  });

  applyFilters();

});
</script>


{% endblock %}