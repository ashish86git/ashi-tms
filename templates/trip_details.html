{% extends "layout.html" %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-dark" style="font-family: 'Inter', sans-serif; font-weight: 600;">
            <i class="bi bi-geo-alt-fill text-primary me-2"></i>Trip Monitoring Flow
        </h2>
        <div class="text-muted small">
            <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2">System Active</span>
        </div>
    </div>

    <div class="card shadow-sm border-0" style="border-radius: 20px; background: #ffffff;">
        <div id="tripGraph" style="height: 580px; width: 100%; border-radius: 20px;"></div>
    </div>
</div>

{% if table %}
<div class="table-responsive mt-4">{{ table|safe }}</div>
{% endif %}

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<style>
    /* Premium Look Refinements */
    #tripGraph canvas {
        cursor: grab !important;
    }
    #tripGraph canvas:active {
        cursor: grabbing !important;
    }
    .vis-network {
        outline: none !important;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const indentId = "{{ indent_id }}";
    if (!indentId) return;

    /* UPDATED HELPER FUNCTION: STRICT IST CONVERSION */
    function formatToIST(dateString) {
        if (!dateString || dateString === "---" || dateString === "-" || dateString === "None") return "---";

        try {
            // Check if string already contains a 'Z' or '+', if not, it might be raw local time from DB
            let date = new Date(dateString);

            // If the date is invalid, try cleaning it
            if (isNaN(date.getTime())) return dateString;

            // Strict IST Formatting
            return new Intl.DateTimeFormat('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            }).format(date);

        } catch (e) {
            console.error("Format Error:", e);
            return dateString;
        }
    }

    fetch(`/api-trip-details/${indentId}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) return;

            /* ======================
               SMART NODES DATA (WITH FIXED IST)
            ====================== */
            const nodeDetails = [
                { id: 1, color: "#10b981", icon: "ðŸ“¥", title: "RECEIVED", val: formatToIST(data.received_time) },
                { id: 2, color: "#3b82f6", icon: "ðŸ—ï¸", title: "LOADING", val: formatToIST(data.loading_time) },
                { id: 3, color: "#3b82f6", icon: "ðŸ…¿ï¸", title: "PARKING", val: formatToIST(data.parking_time) },
                { id: 4, color: "#3b82f6", icon: "ðŸ­", title: "EXIT YARD", val: formatToIST(data.exit_time) },
                { id: 5, color: "#f59e0b", icon: "ðŸšš", title: "IN TRANSIT", val: `${data.total_distance || 0} km | ${data.duration_hours || 0} hrs` },
                { id: 6, color: "#8b5cf6", icon: "ðŸ“", title: "ARRIVAL", val: formatToIST(data.actual_arrival_time) },
                { id: 7, color: "#06b6d4", icon: "ðŸ“¦", title: "UNLOADING", val: formatToIST(data.loading_unloading_time) },
                { id: 8, color: "#ef4444", icon: "âœ…", title: "DROP DONE", val: formatToIST(data.actual_arrival_time) }
            ];

            const nodes = nodeDetails.map(n => ({
                id: n.id,
                label: `${n.icon} ${n.title}\n${n.val}`,
                shape: "box",
                margin: { top: 15, bottom: 15, left: 20, right: 20 },
                font: {
                    size: 14,
                    face: 'Inter, sans-serif',
                    color: '#334155',
                    vadjust: 2,
                    bold: { color: '#1e293b', size: 15 }
                },
                color: {
                    background: '#ffffff',
                    border: n.color,
                    highlight: { background: '#f8fafc', border: n.color }
                },
                borderWidth: 2,
                shadow: { enabled: true, color: 'rgba(0,0,0,0.06)', size: 8, x: 0, y: 4 }
            }));

            /* ======================
               EDGES (CONNECTIONS)
            ====================== */
            const edges = [
                { from: 1, to: 2 }, { from: 2, to: 3 }, { from: 3, to: 4 },
                { from: 4, to: 5 }, { from: 5, to: 6 }, { from: 6, to: 7 }, { from: 7, to: 8 }
            ].map(e => ({
                ...e,
                arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                color: { color: '#cbd5e1', highlight: '#3b82f6' },
                width: 2,
                smooth: { type: 'cubicBezier', forceDirection: 'horizontal', roundness: 0.6 }
            }));

            const container = document.getElementById("tripGraph");
            const options = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: "LR",
                        sortMethod: "directed",
                        levelSeparation: 250,
                        nodeSpacing: 160
                    }
                },
                physics: false,
                interaction: {
                    zoomView: false,
                    dragView: true,
                    hover: true
                },
                nodes: {
                    widthConstraint: { minimum: 180, maximum: 220 },
                    shapeProperties: { borderRadius: 12 }
                }
            };

            const network = new vis.Network(container, { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) }, options);

            network.once('afterDrawing', function() {
                network.fit({ animation: true });
            });
        })
        .catch(err => console.error("API Error:", err));
});
</script>

{% endblock %}