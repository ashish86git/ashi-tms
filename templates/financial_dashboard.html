{% extends "layout.html" %}
{% block content %}
<div class="container-fluid py-5 px-4">
  <div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h2 class="fw-bold text-primary mb-0">
        <i class="bi bi-bar-chart-line me-2"></i> Transport Financial Dashboard
      </h2>
      <p class="text-muted">Trip Summary Table with Download Option</p>
    </div>
    <button class="btn btn-primary" onclick="downloadTableAsCsv()">
      <i class="bi bi-download me-2"></i> Download as CSV
    </button>
  </div>

  <!-- Data Table -->
  <div class="mt-5">
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white fw-semibold">Trip Summary Table</div>
      <div class="table-responsive">
        <table id="tripTable" class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Vehicle</th>
              <th>Driver</th>
              <th>Indent Date</th>
              <th>Pickup</th>
              <th>Drop</th>
              <th>Total Km (TpT)</th>
              <th>Rate</th>
              <th>Total Cost</th>
              <th>Total Cost (Loading)</th>
              <th>Criteria</th>
              <th>Total Cost (Unload)</th>
              <th>Any Other Cost</th>
              <th>Total Cost (Final)</th>
              <th>Criteria</th>
              <th>Cost</th>
              <th>Revenue</th>
              <th>P & L</th>
            </tr>
          </thead>
          <tbody>
            {% for t in routes %}
              <tr>
                <td>{{ t.vehicle_id }}</td>
                <td>{{ t.driver_name }}</td>
                <td>{{ t.indent_date }}</td>
                <td>{{ t.pickup }}</td>
                <td>{{ t.drop }}</td>
                <td>{{ t.total_km }}</td>
                <td>{{ t.rate }}</td>
                <td>{{ t.total_cost }}</td>
                <td>{{ t.total_cost_loading }}</td>
                <td>{{ t.criteria_loading }}</td>
                <td>{{ t.total_cost_unload }}</td>
                <td>{{ t.other_cost }}</td>
                <td>{{ t.final_total_cost }}</td>
                <td>{{ t.criteria_unload }}</td>
                <td>{{ t.cost }}</td>
                <td>{{ t.revenue }}</td>
                <td>{{ t.pnl }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Required Scripts -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<script>
    function downloadTableAsCsv() {
        const table = document.getElementById('tripTable');
        let csv = [];
        // Get headers
        let headers = [];
        for (let th of table.querySelectorAll('thead th')) {
            headers.push(th.innerText);
        }
        csv.push(headers.join(','));

        // Get rows
        for (let row of table.querySelectorAll('tbody tr')) {
            let rowData = [];
            for (let cell of row.querySelectorAll('td')) {
                rowData.push(cell.innerText.replace(/"/g, '""'));
            }
            csv.push(rowData.join(','));
        }

        const csvString = csv.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'trip_summary.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
