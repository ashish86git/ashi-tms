{% extends "layout.html" %}
{% block content %}

<style>
/* ================= UI Enhancements ================= */
.dashboard-title {
    font-weight: 600;
}

.filter-card label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #555;
}

.table thead th {
    white-space: nowrap;
}

.summary-card {
    min-height: 90px;
}

.summary-card h6 {
    font-size: 0.9rem;
    font-weight: 600;
}

.summary-card p {
    font-size: 0.75rem;
    margin-bottom: 0;
}

.info-pill {
    font-size: 0.75rem;
    padding: 4px 10px;
}

@media (max-width: 768px) {
    .summary-row {
        overflow-x: auto;
        flex-wrap: nowrap;
    }

    .summary-row .col-md-3 {
        min-width: 220px;
    }

    .table-responsive {
        font-size: 0.75rem;
    }
}
</style>

<div class="container-fluid mt-3">

    <!-- ================= HEADER ================= -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
        <h4 class="text-primary dashboard-title mb-0">
            üí∞ Trip Cost Dashboard
        </h4>

        <a href="{{ url_for('financial',
                export='csv',
                vehicle_id=vehicle_filter,
                driver_name=driver_filter,
                start_date=start_date,
                end_date=end_date) }}"
           class="btn btn-success btn-sm shadow-sm">
            ‚¨á Export CSV
        </a>
    </div>

    <!-- ================= COST INFO BAR ================= -->
    <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
        <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-primary info-pill">Fuel Type: CNG</span>
            <span class="badge bg-success info-pill">Fuel Rate: ‚Çπ88</span>
<!--            <span class="badge bg-dark info-pill">Vehicle Avg: Distance √∑ 6</span>-->
        </div>

        <button class="btn btn-outline-primary btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#costLogicModal">
            ‚ÑπÔ∏è View Cost Logic
        </button>
    </div>

    <!-- ================= FILTERS ================= -->
    <form method="get" class="card filter-card p-3 mb-3 shadow-sm border-0">
        <div class="row g-3 align-items-end">

            <div class="col-md-2 col-6">
                <label>Vehicle</label>
                <input type="text" name="vehicle_id"
                       class="form-control form-control-sm"
                       placeholder="Vehicle ID"
                       value="{{ vehicle_filter }}">
            </div>

            <div class="col-md-3 col-6">
                <label>Driver</label>
                <input type="text" name="driver_name"
                       class="form-control form-control-sm"
                       placeholder="Driver Name"
                       value="{{ driver_filter }}">
            </div>

            <div class="col-md-2 col-6">
                <label>Start Date</label>
                <input type="date" name="start_date"
                       class="form-control form-control-sm"
                       value="{{ start_date }}">
            </div>

            <div class="col-md-2 col-6">
                <label>End Date</label>
                <input type="date" name="end_date"
                       class="form-control form-control-sm"
                       value="{{ end_date }}">
            </div>

            <div class="col-md-3 col-12 text-end">
                <button class="btn btn-primary btn-sm me-1">üîç Apply</button>
                <a href="{{ url_for('financial') }}"
                   class="btn btn-outline-secondary btn-sm">
                    Reset
                </a>
            </div>

        </div>
    </form>

    <!-- ================= SUMMARY ================= -->
    <div class="row mb-3 summary-row g-2">
        {% for s in summary.values() %}
        <div class="col-md-3">
            <div class="card summary-card shadow-sm border-start border-4 border-danger">
                <div class="card-body p-2">
                    <h6 class="mb-1 text-primary">üöö {{ s['Vehicle ID'] }}</h6>
                    <p>Trips: <strong>{{ s['Trips'] }}</strong></p>
                    <p class="text-danger fw-semibold">
                        ‚Çπ {{ "%.2f"|format(s['Total Cost']) }}
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ================= TABLE ================= -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">

            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle mb-0">
                    <thead class="table-dark text-center">
                        <tr>
                            <th>Vehicle</th>
                            <th>Driver</th>
                            <th>Indent</th>
                            <th>Material</th>
                            <th class="text-end">
                                Distance (KM)
                                <span class="text-info"
                                      data-bs-toggle="tooltip"
                                      title="Distance + 20 KM √∑ 6 √ó ‚Çπ78">
                                    ‚ÑπÔ∏è
                                </span>
                            </th>
                            <th class="text-end">Material Cost (‚Çπ)</th>
                            <th class="text-end">Total Cost (‚Çπ)</th>
                        </tr>
                    </thead>

                    <tbody>
                    {% for r in routes %}
                        <tr>
                            <td>{{ r['Vehicle ID'] }}</td>
                            <td>{{ r['Driver Name'] }}</td>
                            <td class="fw-semibold">{{ r['Indent'] }}</td>
                            <td>{{ r['Material'] }}</td>

                            <td class="text-end">
                                {{ "%.2f"|format(r['Distance (KM)']) }}
                            </td>

                            <td class="text-end">
                                {{ "%.2f"|format(r['Material Cost']) }}
                            </td>

                            <td class="text-end fw-bold text-danger">
                                {{ "%.2f"|format(r['Total Cost Per Trip']) }}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                No records found
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>

</div>

<!-- ================= COST LOGIC MODAL ================= -->
<div class="modal fade" id="costLogicModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h6 class="modal-title">üìä Trip Cost Calculation Logic</h6>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body small">

        <p><strong>Fuel Type:</strong> CNG</p>
        <p><strong>Fuel Rate Used:</strong> ‚Çπ78</p>

        <hr>

        <p><strong>Distance Cost Formula:</strong></p>
        <code>(Trip Distance + 20 KM) √∑ 6 √ó 78</code>

        <hr>

        <p><strong>Material Cost Formula:</strong></p>
        <code>No. of Buckets √ó Material Rate</code>

        <hr>

        <p class="fw-bold text-danger">
            Total Cost = Distance Cost + Material Cost
        </p>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm"
                data-bs-dismiss="modal">
            Close
        </button>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.map(function (el) {
        return new bootstrap.Tooltip(el);
    });
});
</script>

{% endblock %}
