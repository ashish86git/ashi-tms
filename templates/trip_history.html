{% extends "layout.html" %}

{% block content %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<h2 class="mb-4 text-primary">üöö Trip History Dashboard</h2>

<div class="mb-3 d-flex justify-content-end">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#vehiclePoolModal">
        üöò Vehicle Pool
    </button>
</div>

<div class="modal fade" id="vehiclePoolModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üöó Vehicle Pool</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="background-color: #f8f9fa;">
                {% set ns = namespace(closed=[], intransit=[]) %}
                {% for t in trips %}
                    {% if t.vehicle_no %}
                        {% if t.actual_arrival_time and t.loading_unloading_time and t.pod_url == 'POD Recieved' %}
                            {% if t.vehicle_no not in ns.closed %}
                                {% set ns.closed = ns.closed + [t.vehicle_no] %}
                            {% endif %}
                        {% else %}
                            {% if t.vehicle_no not in ns.intransit %}
                                {% set ns.intransit = ns.intransit + [t.vehicle_no] %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <h6 class="text-primary mb-2">üöß In-Transit Vehicles</h6>
                {% if ns.intransit %}
                    <ul class="list-group mb-4">
                        {% for vehicle in ns.intransit %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="background:#fff3cd; border:1px solid #ffca2c; opacity:0.7; cursor:not-allowed;">
                                <strong class="text-dark">{{ vehicle }}</strong>
                                <span class="badge bg-warning text-dark rounded-pill px-3 py-2">In Transit</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No Vehicles In Transit</p>
                {% endif %}

                <h6 class="text-success mb-2">‚úÖ Closed Vehicles</h6>
                {% if ns.closed %}
                    <ul class="list-group">
                        {% for vehicle in ns.closed %}
                            <a href="/trip-history?vehicle={{ vehicle }}" style="text-decoration:none;">
                                <li class="list-group-item d-flex justify-content-between align-items-center" style="background:white; border:1px solid #198754;">
                                    <strong class="text-dark">{{ vehicle }}</strong>
                                    <span class="badge bg-success rounded-pill px-3 py-2">Closed</span>
                                </li>
                            </a>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No Vehicles Closed</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="controls-row">
    <div class="row mb-4">
        <div class="col-md-6">
            <h5 class="mb-2">Filter by Status</h5>
            <div class="d-flex">
                <button id="showAll" class="btn btn-dark me-2 btn-active">All Trips</button>
                <button id="showPending" class="btn btn-warning me-2">Pending</button>
                <button id="showClosed" class="btn btn-success">Closed</button>
            </div>
        </div>
        <div class="col-md-4">
            <h5 class="mb-2">Vehicle Based Filter</h5>
            <select id="vBasedFilter" class="form-select">
                <option value="">All Types</option>
                <option value="Market">Market</option>
                <option value="Own">Own</option>
                <option value="Attached">Attached</option>
            </select>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <h5 class="mb-2">Search Filters</h5>
        <div class="col-md-3"><label class="form-label">Customer Name</label><input type="text" id="customerFilter" class="form-control" placeholder="Search customer"></div>
        <div class="col-md-3"><label class="form-label">Vehicle No.</label><input type="text" id="vehicleFilter" class="form-control" placeholder="Search vehicle"></div>
        <div class="col-md-3"><label class="form-label">Indent ID</label><input type="text" id="indentFilter" class="form-control" placeholder="Search indent"></div>
        <div class="col-md-3"><label class="form-label">LR Number</label><input type="text" id="lrFilter" class="form-control" placeholder="Search LR number"></div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-3"><label class="form-label">Created Date (Start)</label><input type="date" id="startDateFilter" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Created Date (End)</label><input type="date" id="endDateFilter" class="form-control"></div>
        <div class="col-md-6 d-flex align-items-end justify-content-end"><button id="clearFilters" class="btn btn-secondary">Clear All Filters</button></div>
    </div>

    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-end">
            <button id="exportExcel" class="btn btn-outline-primary me-2">Export Excel (.xlsx)</button>
            <button id="exportCSV" class="btn btn-outline-success">Export CSV</button>
        </div>
    </div>
</div>

<div class="table-responsive mt-4">
<table class="table table-bordered table-striped align-middle" id="tripTable">
<thead class="table-dark">
<tr>
    <th>ID</th><th>Indent ID</th><th>Customer Name</th><th>Vehicle</th><th>Driver</th><th>Contact</th>
    <th>Pickup</th><th>Drop</th><th>Drops</th><th>Vehicle Based</th>
    <th class="bg-primary text-white">Fixed Amount</th> <th>Exit Time</th><th>ETA Arrival</th><th>Actual Arrival</th>
    <th>LR Number</th><th>Loading / Unloading Time</th><th>Distance</th><th>Duration</th><th>Customer Details</th><th>POD Status</th><th>Created At</th><th class="no-export">Action</th>
</tr>
</thead>

<tbody>
{% for t in trips %}
<tr
    data-status="{% if t.actual_arrival_time and t.loading_unloading_time and t.pod_url == 'POD Recieved' %}closed{% else %}pending{% endif %}"
    data-indent="{{ t.indent_id|lower }}"
    data-vehicle="{{ t.vehicle_no|lower }}"
    data-customer="{{ t.customer_name|lower }}"
    data-lr="{{ t.lr_no|lower if t.lr_no else '' }}"
    data-vbased="{{ t.vehicle_based|lower if t.vehicle_based else '' }}"
    data-created="{{ t.created_at.strftime('%Y-%m-%d') if t.created_at else '' }}"
>
    <td>{{ t.id }}</td>
    <td><a href="/def?indent_id={{ t.indent_id }}" class="text-decoration-none fw-bold text-primary">{{ t.indent_id }}</a></td>
    <td>{{ t.customer_name }}</td>
    <td>{{ t.vehicle_no }}</td>
    <td>{{ t.driver_name }}</td>
    <td>{{ t.driver_contact }}</td>
    <td>{{ t.pickup }}</td>
    <td>{{ t.drop_location }}</td>
    <td>{{ t.total_drops }}</td>
    <td>{{ t.vehicle_based }}</td>

    <td>
        {% if t.vehicle_based|lower == 'market' %}
            <div class="input-group input-group-sm" style="width: 140px;">
                <input type="number" id="amt_{{ t.id }}" class="form-control" value="{{ t.fixed_amount if t.fixed_amount else '' }}" placeholder="Amt">
                <button class="btn btn-primary" type="button" onclick="saveFixedAmount('{{ t.id }}', this)">
                    üíæ
                </button>
            </div>
        {% else %}
            <span class="text-muted">-</span>
        {% endif %}
    </td>

    <td>{{ t.exit_time }}</td>
    <td>{{ t.eta_arrival_time }}</td>
    <td>{{ t.actual_arrival_time if t.actual_arrival_time else "-" }}</td>
    <td>{{ t.lr_no if t.lr_no else "-" }}</td>
    <td>{{ t.loading_unloading_time if t.loading_unloading_time else "-" }}</td>
    <td>{{ t.total_distance }}</td>
    <td>{{ t.duration_hours }}</td>
    <td>{{ t.customer_details }}</td>
    <td>{{ t.pod_url if t.pod_url else "N/A" }}</td>
    <td>{{ t.created_at }}</td>
    <td class="no-export">
        {% if not (t.actual_arrival_time and t.loading_unloading_time and t.pod_url == 'POD Recieved') %}
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#closeModal{{ t.id }}">Close Trip</button>
        {% else %}
        <span class="badge bg-success">Closed</span>
        {% endif %}
        <div class="modal fade" id="closeModal{{ t.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/close-indent/{{ t.id }}" method="POST" class="close-form">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Trip - {{ t.indent_id }}</h5>
                            <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="actual_arrival_time" value="{{ t.actual_arrival_time if t.actual_arrival_time else '' }}">
                            <input type="hidden" name="loading_unloading_time" value="{{ t.loading_unloading_time if t.loading_unloading_time else '' }}">
                            <input type="hidden" name="pod_url" value="{{ t.pod_url if t.pod_url else '' }}">
                            <div class="d-grid gap-3">
                                <button type="button" class="btn btn-actual {% if t.actual_arrival_time %}btn-primary{% else %}btn-outline-primary{% endif %}" {% if t.actual_arrival_time %}disabled{% endif %}>
                                    {% if t.actual_arrival_time %}‚úÖ Actual Arrival Set{% else %}üìç Set Actual Arrival Time{% endif %}
                                </button>
                                <button type="button" class="btn btn-loading {% if t.loading_unloading_time %}btn-warning{% else %}btn-outline-warning{% endif %}" {% if not t.actual_arrival_time or t.loading_unloading_time %}disabled{% endif %}>
                                    {% if t.loading_unloading_time %}‚úÖ Loading / Unloading Set{% else %}‚è±Ô∏è Set Loading / Unloading Time{% endif %}
                                </button>
                                <button type="button" class="btn btn-pod {% if t.pod_url == 'POD Recieved' %}btn-success{% else %}btn-outline-success{% endif %}" {% if not t.loading_unloading_time or t.pod_url == 'POD Recieved' %}disabled{% endif %}>
                                    {% if t.pod_url == 'POD Recieved' %}‚úÖ POD Received{% else %}üìÑ POD Received{% endif %}
                                </button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success main-submit-btn" disabled>Final Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<script>
// Logic to Save Amount via Fetch API (Unchanged)
function saveFixedAmount(tripId, btnElement) {
    const amount = document.getElementById(`amt_${tripId}`).value;
    btnElement.innerText = "‚è≥";
    btnElement.disabled = true;

    fetch('/update-fixed-amount', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trip_id: tripId, amount: amount })
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            btnElement.innerText = "‚úÖ";
            btnElement.className = "btn btn-success";
            setTimeout(() => {
                btnElement.innerText = "üíæ";
                btnElement.className = "btn btn-primary";
                btnElement.disabled = false;
            }, 2000);
        } else {
            alert("Error: " + data.message);
            btnElement.innerText = "‚ùå";
            btnElement.disabled = false;
        }
    })
    .catch(err => {
        console.error(err);
        btnElement.innerText = "üíæ";
        btnElement.disabled = false;
    });
}

$(document).ready(function() {
    // INITIALIZE DATATABLE WITH LATEST FIRST SORTING
    const table = $('#tripTable').DataTable({
        "paging": true,
        "pageLength": 10,
        "ordering": true,
        "order": [[0, "desc"]], // Column 0 (ID) in Descending Order (Naya sabse upar)
        "info": true,
        "searching": true,
        "dom": 'lrtip'
    });

    // Custom Filters
    const filters = {
        customer: document.getElementById("customerFilter"),
        vehicle: document.getElementById("vehicleFilter"),
        indent: document.getElementById("indentFilter"),
        lr: document.getElementById("lrFilter"),
        start: document.getElementById("startDateFilter"),
        end: document.getElementById("endDateFilter"),
        vbased: document.getElementById("vBasedFilter")
    };

    let statusFilterValue = "all";

    function applyFilters() {
        $('.controls-row .btn').removeClass('btn-active');
        if (statusFilterValue === "all") $("#showAll").addClass('btn-active');
        if (statusFilterValue === "pending") $("#showPending").addClass('btn-active');
        if (statusFilterValue === "closed") $("#showClosed").addClass('btn-active');

        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            const row = $(table.row(dataIndex).node());
            const matchStatus = statusFilterValue === "all" || row.attr('data-status') === statusFilterValue;
            const matchCustomer = row.attr('data-customer').includes(filters.customer.value.toLowerCase());
            const matchIndent = row.attr('data-indent').includes(filters.indent.value.toLowerCase());
            const matchVehicle = row.attr('data-vehicle').includes(filters.vehicle.value.toLowerCase());
            const matchLR = row.attr('data-lr').includes(filters.lr.value.toLowerCase());
            const matchVBased = filters.vbased.value === "" || row.attr('data-vbased') === filters.vbased.value.toLowerCase();

            const created = row.attr('data-created');
            let matchDate = true;
            if (filters.start.value && created < filters.start.value) matchDate = false;
            if (filters.end.value && created > filters.end.value) matchDate = false;

            return matchStatus && matchCustomer && matchIndent && matchVehicle && matchLR && matchDate && matchVBased;
        });

        table.draw();
        $.fn.dataTable.ext.search.pop();
    }

    $("#showAll").click(function() { statusFilterValue = "all"; applyFilters(); });
    $("#showPending").click(function() { statusFilterValue = "pending"; applyFilters(); });
    $("#showClosed").click(function() { statusFilterValue = "closed"; applyFilters(); });
    $(filters.vbased).on("change", applyFilters);
    $(".controls-row input").on("input change", applyFilters);
    $("#clearFilters").click(function() {
        $(".controls-row input, .controls-row select").val("");
        statusFilterValue = "all";
        applyFilters();
    });

    // EXPORT LOGIC
    function getFilteredDataForExport() {
        const headers = [];
        $('#tripTable thead th').each(function() {
            if (!$(this).hasClass('no-export')) headers.push($(this).text().trim());
        });
        const visibleData = [headers];
        table.rows({ filter: 'applied' }).nodes().each(function(node) {
            const rowData = [];
            $(node).find('td').each(function() {
                if (!$(this).hasClass('no-export')) {
                    const input = $(this).find('input');
                    rowData.push(input.length > 0 ? (input.val() || "0") : $(this).text().trim());
                }
            });
            visibleData.push(rowData);
        });
        return visibleData;
    }

    $("#exportExcel").click(function() {
        const data = getFilteredDataForExport();
        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Trips");
        XLSX.writeFile(workbook, "Trip_History_Report.xlsx");
    });

    $("#exportCSV").click(function() {
        const data = getFilteredDataForExport();
        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const csvOutput = XLSX.utils.sheet_to_csv(worksheet);
        const blob = new Blob([csvOutput], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Trip_History_Report.csv";
        link.click();
    });

    // Modal Workflow (Logic Unchanged)
    function nowDateTime() {
        const d = new Date();
        const pad = n => n.toString().padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function nowTime() {
        const d = new Date();
        const pad = n => n.toString().padStart(2, "0");
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    $(document).on("click", ".btn-actual", function() {
        const form = $(this).closest('form');
        form.find("input[name='actual_arrival_time']").val(nowDateTime());
        $(this).removeClass("btn-outline-primary").addClass("btn-primary").text("‚úÖ Actual Arrival Set").prop("disabled", true);
        form.find(".btn-loading").prop("disabled", false);
        checkFinalStatus(form);
    });

    $(document).on("click", ".btn-loading", function() {
        const form = $(this).closest('form');
        form.find("input[name='loading_unloading_time']").val(nowTime());
        $(this).removeClass("btn-outline-warning").addClass("btn-warning").text("‚úÖ Loading / Unloading Set").prop("disabled", true);
        form.find(".btn-pod").prop("disabled", false);
        checkFinalStatus(form);
    });

    $(document).on("click", ".btn-pod", function() {
        const form = $(this).closest('form');
        form.find("input[name='pod_url']").val("POD Recieved");
        $(this).removeClass("btn-outline-success").addClass("btn-success").text("‚úÖ POD Received").prop("disabled", true);
        checkFinalStatus(form);
    });

    function checkFinalStatus(form) {
        const actual = form.find("input[name='actual_arrival_time']").val();
        const loading = form.find("input[name='loading_unloading_time']").val();
        const pod = form.find("input[name='pod_url']").val();
        if (actual && loading && pod === "POD Recieved") {
            form.find(".main-submit-btn").prop("disabled", false);
        }
    }
});
</script>

<style>
    .btn-active { border: 2px solid #000 !important; font-weight: bold; }
    .controls-row { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #dee2e6; }
    .dataTables_paginate .pagination { margin-top: 15px; justify-content: flex-end; }
    .dataTables_length { margin-bottom: 10px; }
</style>
{% endblock %}