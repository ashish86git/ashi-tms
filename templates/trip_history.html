{% extends "layout.html" %}

{% block content %}

<h2 class="mb-4 text-primary">üöö Trip History Dashboard</h2>

<div class="mb-3 d-flex justify-content-end">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#vehiclePoolModal">
        üöò Vehicle Pool
    </button>
</div>

<div class="modal fade" id="vehiclePoolModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üöó Vehicle Pool</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" style="background-color: #f8f9fa;">
                {% set ns = namespace(closed=[], intransit=[]) %}

                {% for t in trips %}
                    {% if t.vehicle_no %}
                        {% if t.actual_arrival_time and t.loading_unloading_time and t.pod_url == 'POD Recieved' %}
                            {% if t.vehicle_no not in ns.closed %}
                                {% set ns.closed = ns.closed + [t.vehicle_no] %}
                            {% endif %}
                        {% else %}
                            {% if t.vehicle_no not in ns.intransit %}
                                {% set ns.intransit = ns.intransit + [t.vehicle_no] %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <h6 class="text-primary mb-2">üöß In-Transit Vehicles</h6>
                {% if ns.intransit %}
                    <ul class="list-group mb-4">
                        {% for vehicle in ns.intransit %}
                            <li class="list-group-item d-flex justify-content-between align-items-center"
                                style="background:#fff3cd; border:1px solid #ffca2c; opacity:0.7; cursor:not-allowed;">
                                <strong class="text-dark">{{ vehicle }}</strong>
                                <span class="badge bg-warning text-dark rounded-pill px-3 py-2">In Transit</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No Vehicles In Transit</p>
                {% endif %}

                <h6 class="text-success mb-2">‚úÖ Closed Vehicles</h6>
                {% if ns.closed %}
                    <ul class="list-group">
                        {% for vehicle in ns.closed %}
                            <a href="/trip-history?vehicle={{ vehicle }}" style="text-decoration:none;">
                                <li class="list-group-item d-flex justify-content-between align-items-center"
                                    style="background:white; border:1px solid #198754;">
                                    <strong class="text-dark">{{ vehicle }}</strong>
                                    <span class="badge bg-success rounded-pill px-3 py-2">Closed</span>
                                </li>
                            </a>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No Vehicles Closed</p>
                {% endif %}
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa;">
                <button class="btn btn-outline-danger" data-bs-modal="dismiss">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="controls-row">
    <div class="row mb-4">
        <h5 class="mb-2">Filter by Status</h5>
        <div class="col-12 d-flex">
            <button id="showAll" class="btn btn-dark me-2 btn-active">All Trips</button>
            <button id="showPending" class="btn btn-warning me-2">Pending</button>
            <button id="showClosed" class="btn btn-success">Closed</button>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <h5 class="mb-2">Search Filters</h5>
        <div class="col-md-3"><label class="form-label">Customer Name</label><input type="text" id="customerFilter" class="form-control" placeholder="Search customer"></div>
        <div class="col-md-3"><label class="form-label">Vehicle No.</label><input type="text" id="vehicleFilter" class="form-control" placeholder="Search vehicle"></div>
        <div class="col-md-3"><label class="form-label">Indent ID</label><input type="text" id="indentFilter" class="form-control" placeholder="Search indent"></div>
        <div class="col-md-3"><label class="form-label">LR Number</label><input type="text" id="lrFilter" class="form-control" placeholder="Search LR number"></div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-3"><label class="form-label">Created Date (Start)</label><input type="date" id="startDateFilter" class="form-control"></div>
        <div class="col-md-3"><label class="form-label">Created Date (End)</label><input type="date" id="endDateFilter" class="form-control"></div>
        <div class="col-md-6 d-flex align-items-end justify-content-end"><button id="clearFilters" class="btn btn-secondary">Clear All Filters</button></div>
    </div>

    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-end">
            <button id="exportExcel" class="btn btn-outline-primary me-2">Export Excel</button>
            <button id="exportCSV" class="btn btn-outline-success">Export CSV</button>
        </div>
    </div>
</div>

<div class="table-responsive mt-4">
<table class="table table-bordered table-striped align-middle" id="tripTable">
<thead class="table-dark">
<tr>
    <th>ID</th><th>Indent ID</th><th>Customer Name</th><th>Vehicle</th><th>Driver</th><th>Contact</th>
    <th>Pickup</th><th>Drop</th><th>Drops</th><th>Exit Time</th><th>ETA Arrival</th><th>Actual Arrival</th>
    <th>LR Number</th><th>Loading / Unloading Time</th><th>Distance</th><th>Duration</th><th>Customer Details</th><th>POD</th><th>Created At</th><th>Action</th>
</tr>
</thead>

<tbody>
{% for t in trips %}
<tr
    data-status="{% if t.actual_arrival_time and t.loading_unloading_time and t.pod_url == 'POD Recieved' %}closed{% else %}pending{% endif %}"
    data-indent="{{ t.indent_id|lower }}"
    data-vehicle="{{ t.vehicle_no|lower }}"
    data-customer="{{ t.customer_name|lower }}"
    data-lr="{{ t.lr_no|lower if t.lr_no else '' }}"
    data-created="{{ t.created_at.strftime('%Y-%m-%d') if t.created_at else '' }}"
>
    <td>{{ t.id }}</td>
    <td>{{ t.indent_id }}</td>
    <td>{{ t.customer_name }}</td>
    <td>{{ t.vehicle_no }}</td>
    <td>{{ t.driver_name }}</td>
    <td>{{ t.driver_contact }}</td>
    <td>{{ t.pickup }}</td>
    <td>{{ t.drop_location }}</td>
    <td>{{ t.total_drops }}</td>
    <td>{{ t.exit_time }}</td>
    <td>{{ t.eta_arrival_time }}</td>
    <td>{{ t.actual_arrival_time if t.actual_arrival_time else "-" }}</td>
    <td>{{ t.lr_no if t.lr_no else "-" }}</td>
    <td>{{ t.loading_unloading_time if t.loading_unloading_time else "-" }}</td>
    <td>{{ t.total_distance }}</td>
    <td>{{ t.duration_hours }}</td>
    <td>{{ t.customer_details }}</td>
    <td>
        {% if t.pod_url == 'POD Recieved' %}
            <span class="badge bg-primary">POD Recieved</span>
        {% elif t.actual_arrival_time %}
            <span class="badge bg-warning text-dark">POD Pending</span>
        {% else %} N/A {% endif %}
    </td>
    <td>{{ t.created_at }}</td>
    <td>
        {% if not (t.actual_arrival_time and t.loading_unloading_time and t.pod_url == 'POD Recieved') %}
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#closeModal{{ t.id }}">
            Close Trip
        </button>
        {% else %}
        <span class="badge bg-success px-3 py-2">Closed</span>
        {% endif %}

        <div class="modal fade" id="closeModal{{ t.id }}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <form action="/close-indent/{{ t.id }}" method="POST" class="close-form">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">Trip - {{ t.indent_id }}</h5>
                  <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" name="actual_arrival_time" value="{{ t.actual_arrival_time if t.actual_arrival_time else '' }}">
                  <input type="hidden" name="loading_unloading_time" value="{{ t.loading_unloading_time if t.loading_unloading_time else '' }}">
                  <input type="hidden" name="pod_url" value="{{ t.pod_url if t.pod_url else '' }}">

                  <div class="d-grid gap-3">
                    <button type="button" class="btn btn-actual {% if t.actual_arrival_time %}btn-primary{% else %}btn-outline-primary{% endif %}" {% if t.actual_arrival_time %}disabled{% endif %}>
                      {% if t.actual_arrival_time %}‚úÖ Actual Arrival Set{% else %}üìç Set Actual Arrival Time{% endif %}
                    </button>

                    <button type="button" class="btn btn-loading {% if t.loading_unloading_time %}btn-warning{% else %}btn-outline-warning{% endif %}"
                      {% if not t.actual_arrival_time or t.loading_unloading_time %}disabled{% endif %}>
                      {% if t.loading_unloading_time %}‚úÖ Loading / Unloading Set{% else %}‚è±Ô∏è Set Loading / Unloading Time{% endif %}
                    </button>

                    <button type="button" class="btn btn-pod {% if t.pod_url == 'POD Recieved' %}btn-success{% else %}btn-outline-success{% endif %}"
                      {% if not t.loading_unloading_time or t.pod_url == 'POD Recieved' %}disabled{% endif %}>
                      {% if t.pod_url == 'POD Recieved' %}‚úÖ POD Received{% else %}üìÑ POD Received{% endif %}
                    </button>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-success main-submit-btn" disabled>Final Close</button>
                </div>
              </form>
            </div>
          </div>
        </div>
    </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // 1. FILTER & EXPORT (Unchanged Logic)
    const filters = {
        customer: document.getElementById("customerFilter"),
        vehicle: document.getElementById("vehicleFilter"),
        indent: document.getElementById("indentFilter"),
        lr: document.getElementById("lrFilter"),
        start: document.getElementById("startDateFilter"),
        end: document.getElementById("endDateFilter")
    };
    const rows = document.querySelectorAll("#tripTable tbody tr");
    let statusFilter = "all";

    function applyFilters() {
        document.querySelectorAll('.controls-row .btn').forEach(btn => btn.classList.remove('btn-active'));
        if (statusFilter === "all") document.getElementById("showAll").classList.add('btn-active');
        if (statusFilter === "pending") document.getElementById("showPending").classList.add('btn-active');
        if (statusFilter === "closed") document.getElementById("showClosed").classList.add('btn-active');

        rows.forEach(row => {
            const matchStatus = statusFilter === "all" || row.dataset.status === statusFilter;
            const matchCustomer = row.dataset.customer.includes(filters.customer.value.toLowerCase());
            const matchIndent = row.dataset.indent.includes(filters.indent.value.toLowerCase());
            const matchVehicle = row.dataset.vehicle.includes(filters.vehicle.value.toLowerCase());
            const matchLR = row.dataset.lr.includes(filters.lr.value.toLowerCase());
            const created = row.dataset.created;
            let matchDate = true;
            if (filters.start.value && created < filters.start.value) matchDate = false;
            if (filters.end.value && created > filters.end.value) matchDate = false;
            row.style.display = matchStatus && matchCustomer && matchIndent && matchVehicle && matchLR && matchDate ? "" : "none";
        });
    }

    document.getElementById("showAll").onclick = () => { statusFilter = "all"; applyFilters(); };
    document.getElementById("showPending").onclick = () => { statusFilter = "pending"; applyFilters(); };
    document.getElementById("showClosed").onclick = () => { statusFilter = "closed"; applyFilters(); };
    Object.values(filters).forEach(input => input.addEventListener("input", applyFilters));
    document.getElementById("clearFilters").onclick = () => {
        Object.values(filters).forEach(i => i.value = "");
        statusFilter = "all";
        applyFilters();
    };

    // 2. EXPORT FUNCTIONS
    document.getElementById("exportCSV").addEventListener("click", () => exportTable("csv"));
    document.getElementById("exportExcel").addEventListener("click", () => exportTable("xls"));

    function exportTable(type) {
        let table = document.getElementById("tripTable").cloneNode(true);
        table.querySelectorAll("tbody tr").forEach(row => { if (row.style.display === "none") row.remove(); });
        const blob = new Blob([type === 'csv' ? tableToCSV(table) : table.outerHTML], { type: type === 'csv' ? "text/csv" : "application/vnd.ms-excel" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `trip_history.${type}`;
        a.click();
    }
    function tableToCSV(table) {
        let csv = [];
        table.querySelectorAll("tr").forEach(row => {
            let rowData = [];
            row.querySelectorAll("th, td").forEach(col => rowData.push(col.innerText.replace(/,/g, " ")));
            csv.push(rowData.join(","));
        });
        return csv.join("\n");
    }

    // 3. STEP-BY-STEP MODAL FLOW (ENHANCED)
    function nowDateTime() {
        const d = new Date();
        const pad = n => n.toString().padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function nowTime() {
        const d = new Date();
        const pad = n => n.toString().padStart(2, "0");
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    document.querySelectorAll(".close-form").forEach(form => {
        const actualBtn = form.querySelector(".btn-actual");
        const loadingBtn = form.querySelector(".btn-loading");
        const podBtn = form.querySelector(".btn-pod");
        const submitBtn = form.querySelector(".main-submit-btn");

        const actualInput = form.querySelector("input[name='actual_arrival_time']");
        const loadingInput = form.querySelector("input[name='loading_unloading_time']");
        const podInput = form.querySelector("input[name='pod_url']");

        // Initial Submit State Check
        const checkFinalStatus = () => {
            if (actualInput.value && loadingInput.value && podInput.value === "POD Recieved") {
                submitBtn.disabled = false;
            }
        };
        checkFinalStatus();

        actualBtn.onclick = () => {
            actualInput.value = nowDateTime();
            actualBtn.className = "btn btn-primary btn-actual";
            actualBtn.innerText = "‚úÖ Actual Arrival Set";
            actualBtn.disabled = true;
            loadingBtn.disabled = false;
            checkFinalStatus();
        };

        loadingBtn.onclick = () => {
            loadingInput.value = nowTime();
            loadingBtn.className = "btn btn-warning btn-loading";
            loadingBtn.innerText = "‚úÖ Loading / Unloading Set";
            loadingBtn.disabled = true;
            podBtn.disabled = false;
            checkFinalStatus();
        };

        podBtn.onclick = () => {
            podInput.value = "POD Recieved";
            podBtn.className = "btn btn-success btn-pod";
            podBtn.innerText = "‚úÖ POD Received";
            podBtn.disabled = true;
            checkFinalStatus();
        };
    });

    applyFilters();
});
</script>

{% endblock %}