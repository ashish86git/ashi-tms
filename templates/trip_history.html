{% extends "layout.html" %}

{% block content %}

<h2 class="mb-4 text-primary">ðŸšš Trip History Dashboard</h2>

<div class="controls-row">

    <!-- Status Buttons -->
    <div class="row mb-4">
        <h5 class="mb-2">Filter by Status</h5>
        <div class="col-12 d-flex">
            <button id="showAll" class="btn btn-dark me-2 btn-active">All Trips</button>
            <button id="showPending" class="btn btn-warning me-2">Pending</button>
            <button id="showClosed" class="btn btn-success">Closed</button>
        </div>
    </div>

    <!-- Text Filters -->
    <div class="row g-3 mb-3">
        <h5 class="mb-2">Search Filters</h5>

        <div class="col-md-3">
            <label class="form-label">Customer Name</label>
            <input type="text" id="customerFilter" class="form-control" placeholder="Search customer">
        </div>

        <div class="col-md-3">
            <label class="form-label">Vehicle No.</label>
            <input type="text" id="vehicleFilter" class="form-control" placeholder="Search vehicle">
        </div>

        <div class="col-md-3">
            <label class="form-label">Indent ID</label>
            <input type="text" id="indentFilter" class="form-control" placeholder="Search indent">
        </div>
    </div>

    <!-- Date Filter -->
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Created Date (Start)</label>
            <input type="date" id="startDateFilter" class="form-control">
        </div>
        <div class="col-md-3">
            <label class="form-label">Created Date (End)</label>
            <input type="date" id="endDateFilter" class="form-control">
        </div>
        <div class="col-md-6 d-flex align-items-end justify-content-end">
            <button id="clearFilters" class="btn btn-secondary">Clear All Filters</button>
        </div>
    </div>
</div>

<!-- Trip History Table -->
<div class="table-responsive mt-4">
    <table class="table table-bordered table-striped align-middle" id="tripTable">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Indent ID</th>
            <th>Customer Name</th>
            <th>Vehicle</th>
            <th>Driver</th>
            <th>Contact</th>
            <th>Pickup</th>
            <th>Drop</th>
            <th>Drops</th>
            <th>Exit Time</th>
            <th>ETA Arrival</th>
            <th>Actual Arrival</th>
            <th>Distance</th>
            <th>Duration</th>
            <th>Customer Details</th>
            <th>POD</th>
            <th>Created At</th>
            <th>Action</th>
        </tr>
        </thead>

        <tbody>
        {% for t in trips %}
        <tr
            data-status="{% if t.actual_arrival_time %}closed{% else %}pending{% endif %}"
            data-indent="{{ t.indent_id|lower }}"
            data-vehicle="{{ t.vehicle_no|lower }}"
            data-customer="{{ t.customer_name|lower }}"
            data-created="{{ t.created_at.strftime('%Y-%m-%d') if t.created_at else '' }}"
        >
            <td>{{ t.id }}</td>
            <td>{{ t.indent_id }}</td>
            <td>{{ t.customer_name }}</td>
            <td>{{ t.vehicle_no }}</td>
            <td>{{ t.driver_name }}</td>
            <td>{{ t.driver_contact }}</td>
            <td>{{ t.pickup }}</td>
            <td>{{ t.drop_location }}</td>
            <td>{{ t.total_drops }}</td>
            <td>{{ t.exit_time }}</td>
            <td>{{ t.eta_arrival_time }}</td>
            <td>{{ t.actual_arrival_time if t.actual_arrival_time else "-" }}</td>
            <td>{{ t.total_distance }}</td>
            <td>{{ t.duration_hours }}</td>
            <td>{{ t.customer_details }}</td>

            <td>
                {% if t.pod_url %}
                <a href="{{ t.pod_url }}" target="_blank" class="text-success">View POD</a>
                {% else %}N/A{% endif %}
            </td>

            <td>{{ t.created_at }}</td>

            <td>
                {% if not t.actual_arrival_time %}
                <button
                    class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#closeModal{{ t.id }}">
                    Close
                </button>
                {% else %}
                <span class="badge bg-success px-3 py-2">Closed</span>
                {% endif %}

                <!-- Close Modal -->
                <div class="modal fade" id="closeModal{{ t.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">

                            <form action="/close-indent/{{ t.id }}" method="POST">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title">Close Trip - {{ t.indent_id }}</h5>
                                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body">
                                    <label class="form-label fw-bold">Actual Arrival Time</label>
                                    <input type="datetime-local" name="actual_arrival_time" class="form-control" required>

                                    <label class="form-label mt-3 fw-bold">POD URL</label>
                                    <input type="url" name="pod_url" class="form-control" required>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-success">Close Trip</button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>

            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const filters = {
        customer: document.getElementById("customerFilter"),
        vehicle: document.getElementById("vehicleFilter"),
        indent: document.getElementById("indentFilter"),
        start: document.getElementById("startDateFilter"),
        end: document.getElementById("endDateFilter")
    };

    const rows = document.querySelectorAll("#tripTable tbody tr");
    let statusFilter = "all";

    function applyFilters() {
        rows.forEach(row => {
            const matchStatus = statusFilter === "all" || row.dataset.status === statusFilter;
            const matchCustomer = row.dataset.customer.includes(filters.customer.value.toLowerCase());
            const matchIndent = row.dataset.indent.includes(filters.indent.value.toLowerCase());
            const matchVehicle = row.dataset.vehicle.includes(filters.vehicle.value.toLowerCase());

            const created = row.dataset.created;
            let matchDate = true;
            if (filters.start.value && created < filters.start.value) matchDate = false;
            if (filters.end.value && created > filters.end.value) matchDate = false;

            row.style.display =
                matchStatus && matchCustomer && matchIndent && matchVehicle && matchDate
                ? "" : "none";
        });
    }

    document.getElementById("showAll").onclick = () => { statusFilter = "all"; applyFilters(); };
    document.getElementById("showPending").onclick = () => { statusFilter = "pending"; applyFilters(); };
    document.getElementById("showClosed").onclick = () => { statusFilter = "closed"; applyFilters(); };

    Object.values(filters).forEach(input =>
        input.addEventListener("input", applyFilters)
    );

    document.getElementById("clearFilters").onclick = () => {
        Object.values(filters).forEach(i => i.value = "");
        statusFilter = "all";
        applyFilters();
    };

    applyFilters();
});
</script>

{% endblock %}
