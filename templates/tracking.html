<!DOCTYPE html>
<html>
<head>
    <title>Live Tracking Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; display: flex; height: 100vh; margin: 0; }
        #sidebar { width: 250px; background-color: #f8f9fa; padding: 15px; overflow-y: auto; border-right: 1px solid #ddd; }
        #map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; }
        h3 { color: #007bff; margin-top: 0; }
        .indent-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .indent-item:hover { background-color: #e2e6ea; }
        .selected-indent { background-color: #007bff; color: white; font-weight: bold; }
        .selected-indent:hover { background-color: #0069d9; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>ЁЯЪЪ Indent рдЯреНрд░реИрдХрд┐рдВрдЧ</h3>
        <p>рдЯреНрд░реИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ Indent рдЪреБрдиреЗрдВ:</p>
        {% for indent in indents %}
            <div class="indent-item"
                 data-indent="{{ indent.indent }}"
                 onclick="loadTracking('{{ indent.indent }}', this)">
                <strong>ID:</strong> {{ indent.indent }}<br>
                <strong>рд╡рд╛рд╣рди:</strong> {{ indent.vehicle_number }}<br>
                <strong>рдбреНрд░рд╛рдЗрд╡рд░:</strong> {{ indent.driver_name }}
            </div>
        {% endfor %}
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var map = L.map('map').setView([20.5937, 78.9629], 5); // рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рднрд╛рд░рдд рдХрд╛ рдХреЗрдВрджреНрд░
        var currentPolyline = null; // рд╡рд░реНрддрдорд╛рди рдкрд╛рде рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП
        var currentMarker = null;   // рд╡рд░реНрддрдорд╛рди рдорд╛рд░реНрдХрд░ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП
        var trackingInterval = null; // рд▓рд╛рдЗрд╡ рдЕрдкрдбреЗрдЯ рдЗрдВрдЯрд░рд╡рд▓

        // OpenStreetMap рдЯрд╛рдЗрд▓ рд▓реЗрдпрд░ рдЬреЛрдбрд╝реЗрдВ
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }).addTo(map);

        /**
         * рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ Indent ID рдХреЗ рд▓рд┐рдП рдЯреНрд░реИрдХрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред
         */
        function loadTracking(indentId, element) {
            console.log("Loading tracking for Indent ID:", indentId);

            // рд╕рд╛рдЗрдбрдмрд╛рд░ рдореЗрдВ рдЪрдпрди рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
            document.querySelectorAll('.indent-item').forEach(el => {
                el.classList.remove('selected-indent');
            });
            element.classList.add('selected-indent');

            // рдпрджрд┐ рдХреЛрдИ рдкреБрд░рд╛рдирд╛ рдЗрдВрдЯрд░рд╡рд▓ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рддреЛ рдЙрд╕реЗ рдмрдВрдж рдХрд░реЗрдВ
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }

            // рддреБрд░рдВрдд рдПрдХ рдмрд╛рд░ рдкрд╛рде рд▓реЛрдб рдХрд░реЗрдВ рдФрд░ рдлрд┐рд░ рд╣рд░ 10 рд╕реЗрдХрдВрдб рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
            fetchPath(indentId);
            trackingInterval = setInterval(() => fetchPath(indentId), 10000); // 10 рд╕реЗрдХрдВрдб
        }

        /**
         * рд╕рд░реНрд╡рд░ рд╕реЗ рдкрд╛рде рдбреЗрдЯрд╛ рд▓рд╛рддрд╛ рд╣реИ рдФрд░ рдореИрдк рдкрд░ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред
         */
        function fetchPath(indentId) {
            fetch(`/get_path/${indentId}`)
                .then(response => response.json())
                .then(data => {
                    const points = data.points;
                    if (points && points.length > 0) {
                        const latLngs = points.map(p => [p.latitude, p.longitude]);
                        const latestPoint = latLngs[latLngs.length - 1];

                        // 1. рдкрд╛рде (рдкреЙрд▓реАрд▓рд╛рдЗрди) рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
                        if (currentPolyline) {
                            map.removeLayer(currentPolyline);
                        }
                        currentPolyline = L.polyline(latLngs, {color: 'red', weight: 4}).addTo(map);

                        // рдореИрдк рдХреЛ рдкрд╛рде рдХреЗ рдЖрд╕рдкрд╛рд╕ рдлрд╝рд┐рдЯ рдХрд░реЗрдВ
                        map.fitBounds(currentPolyline.getBounds());

                        // 2. рд╡рд░реНрддрдорд╛рди рд╕реНрдерд╛рди (рдорд╛рд░реНрдХрд░) рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                        }

                        // рдорд╛рд░реНрдХрд░ рдХреЛ рдирд╡реАрдирддрдо рд╕реНрдерд╛рди рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВ
                        currentMarker = L.marker(latestPoint).addTo(map)
                            .bindPopup(`<b>Indent: ${indentId}</b><br>
                                        рдЕрдВрддрд┐рдо рдЕрдкрдбреЗрдЯ: ${new Date(points[points.length - 1].timestamp).toLocaleString()}`)
                            .openPopup();
                    } else {
                        // рдпрджрд┐ рдХреЛрдИ рдкреЙрдЗрдВрдЯ рдирд╣реАрдВ рд╣реИ, рддреЛ рдореИрдк рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
                        if (currentPolyline) map.removeLayer(currentPolyline);
                        if (currentMarker) map.removeLayer(currentMarker);
                        console.log("No location data found for this indent.");
                    }
                })
                .catch(error => console.error('Error fetching path:', error));
        }

        // рдкреЗрдЬ рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдпрджрд┐ рдХреЛрдИ Indent рд╣реИ рддреЛ рдкрд╣рд▓реЗ Indent рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЯреНрд░реИрдХ рдХрд░реЗрдВ
        const firstIndentElement = document.querySelector('.indent-item');
        if (firstIndentElement) {
            loadTracking(firstIndentElement.dataset.indent, firstIndentElement);
        }
    </script>
</body>
</html>